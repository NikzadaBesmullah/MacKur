@{
    ViewData["Title"] = "Randevu Al";
    var haliSaha = ViewBag.HaliSaha as haliSahaRandevu.Models.HaliSaha;
}

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .slot-btn {
        width: 100%;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    .slot-btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    .flatpickr-calendar {
        margin: 0 auto;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <div class="row g-0">
                    <!-- Left Side: Field Info -->
                    <div class="col-md-5 bg-light border-end">
                        <div class="p-4 text-center">
                            @if (!string.IsNullOrEmpty(haliSaha?.FotoUrl))
                            {
                                <img src="@haliSaha.FotoUrl" class="img-fluid rounded mb-3 shadow-sm" style="max-height: 150px; object-fit: cover;" />
                            }
                            <h4 class="fw-bold text-primary">@haliSaha?.Ad</h4>
                            <p class="text-muted small mb-2"><i class="bi bi-geo-alt"></i> @haliSaha?.Il, @haliSaha?.Adres</p>
                            <h3 class="fw-bold text-success">@haliSaha?.SaatlikUcret TL <span class="fs-6 text-muted">/ Saat</span></h3>
                        </div>
                        
                        <div class="p-4 border-top bg-white">
                            <h6 class="fw-bold mb-3"><i class="bi bi-info-circle"></i> Kurallar</h6>
                            <ul class="small text-muted ps-3">
                                <li>Randevu alırken %20 ön ödeme alınır.</li>
                                <li>15 dakika içinde ödeme yapılmazsa iptal olur.</li>
                                <li>Lütfen maç saatinden 15 dk önce geliniz.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Right Side: Booking Form -->
                    <div class="col-md-7">
                        <div class="p-4">
                            <h4 class="fw-bold mb-4">Randevu Oluştur</h4>
                            <form asp-action="Create" method="post" id="randevuForm">
                                <input type="hidden" name="haliSahaId" value="@haliSaha?.Id" />
                                <input type="hidden" name="saatAraligi" id="selectedSlot" required />
                                
                                <!-- Step 1: Date -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-muted">1. Tarih Seçiniz</label>
                                    <input type="text" id="datePicker" name="tarih" class="form-control form-control-lg text-center fw-bold text-primary bg-white" placeholder="Tarih Seçin" readonly required />
                                </div>

                                <!-- Step 2: Slots -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-muted">2. Saat Seçiniz</label>
                                    <div id="loadingHours" class="text-center py-3" style="display:none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                        <p class="small text-muted mt-2">Uygun saatler kontrol ediliyor...</p>
                                    </div>
                                    
                                    <div id="slotsContainer" class="row gx-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="col-12 text-center text-muted small p-3 border rounded bg-light">
                                            Lütfen önce tarih seçiniz.
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid mt-5">
                                    <button type="submit" class="btn btn-primary btn-lg shadow-sm" id="btnSubmit" disabled>
                                        Rezervasyonu Tamamla <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js"></script>
    <script>
        $(document).ready(function() {
            // Init Flatpickr
            flatpickr("#datePicker", {
                locale: "tr",
                dateFormat: "Y-m-d",
                minDate: "today",
                disableMobile: "true",
                onChange: function(selectedDates, dateStr, instance) {
                    loadSlots(dateStr);
                }
            });

            function loadSlots(dateStr) {
                $('#loadingHours').show();
                $('#slotsContainer').empty();
                $('#btnSubmit').prop('disabled', true);
                
                var haliSahaId = '@haliSaha?.Id';

                $.ajax({
                    url: '@Url.Action("GetAvailableHours", "Randevu")',
                    type: 'GET',
                    data: { haliSahaId: haliSahaId, date: dateStr },
                    success: function(data) {
                        $('#loadingHours').hide();
                        var container = $('#slotsContainer');
                        
                        if (data.length === 0) {
                            container.html('<div class="col-12"><div class="alert alert-warning text-center">Bu tarihte uygun saat bulunamadı.</div></div>');
                        } else {
                            $.each(data, function(index, time) {
                                var btn = $('<div class="col-4">' +
                                            '<button type="button" class="btn btn-outline-secondary slot-btn" onclick="selectSlot(this, \'' + time + '\')">' + 
                                            time + 
                                            '</button></div>');
                                container.append(btn);
                            });
                        }
                    },
                    error: function() {
                        $('#loadingHours').hide();
                        $('#slotsContainer').html('<div class="text-danger">Saatler yüklenirken hata oluştu.</div>');
                    }
                });
            }
        });

        function selectSlot(btn, time) {
            $('.slot-btn').removeClass('active btn-primary').addClass('btn-outline-secondary');
            $(btn).removeClass('btn-outline-secondary').addClass('active btn-primary');
            
            $('#selectedSlot').val(time);
            $('#btnSubmit').prop('disabled', false);
        }
    </script>
}
